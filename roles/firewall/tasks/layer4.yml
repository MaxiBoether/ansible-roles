- name: install required iptables packages
  package:
    name:
      - iptables
      - iptables-persistent
    state: present

- name: setup/tear down custom chains
  include_tasks: _iptables-custom-chain.yml
  with_dict: "{{ iptables_custom_chains |
                 combine(iptables_custom_chains_extra | default({})) }}"
  vars:
    table: "{{ item.value.table }}"
    chain_name: "{{ item.key }}"
    add_to_chain: "{{ item.value.add_to_chain }}"
    ip_version: "{{ item.ip_version | default('ipv4') }}"
  loop_control:
    label: "{{ item.key }}"

- name: configure iptables rules
  iptables: "{{ {'comment': item.key}
                | combine(item.value) }}"
  loop: "{{ iptables_rules | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  notify: "persist ip{{ item.value.ip_version
                        | default('ipv4')
                        | regex_search('[0-9]') }}tables"
